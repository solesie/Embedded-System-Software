#include <linux/io.h>
#include <linux/string.h>
#include <linux/kernel.h>
#include "fpga_dot.h"
#include "logging.h"

#define IOM_FPGA_DOT_ADDRESS 0x08000210 // pysical address

static const unsigned char fpga_number[10][10] = {
	{0x3e,0x7f,0x63,0x73,0x73,0x6f,0x67,0x63,0x7f,0x3e}, // 0
	{0x0c,0x1c,0x1c,0x0c,0x0c,0x0c,0x0c,0x0c,0x0c,0x1e}, // 1
	{0x7e,0x7f,0x03,0x03,0x3f,0x7e,0x60,0x60,0x7f,0x7f}, // 2
	{0xfe,0x7f,0x03,0x03,0x7f,0x7f,0x03,0x03,0x7f,0x7e}, // 3
	{0x66,0x66,0x66,0x66,0x66,0x66,0x7f,0x7f,0x06,0x06}, // 4
	{0x7f,0x7f,0x60,0x60,0x7e,0x7f,0x03,0x03,0x7f,0x7e}, // 5
	{0x60,0x60,0x60,0x60,0x7e,0x7f,0x63,0x63,0x7f,0x3e}, // 6
	{0x7f,0x7f,0x63,0x63,0x03,0x03,0x03,0x03,0x03,0x03}, // 7
	{0x3e,0x7f,0x63,0x63,0x7f,0x7f,0x63,0x63,0x7f,0x3e}, // 8
};
static const unsigned char fpga_set_blank[10] = {
	// memset(array,0x00,sizeof(array));
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00
};

static unsigned char *iom_fpga_dot_addr;
static int data;

static void print_data(void){
	int i;
	for(i = 0; i < 10; i++)
		outw(fpga_number[data][i] & 0x7F, (unsigned int) iom_fpga_dot_addr + i * 2);
}

void dot_init(char timer_init[FND_MAX + 1]){
	int i;
	iom_fpga_dot_addr = ioremap(IOM_FPGA_DOT_ADDRESS, 0x10);
	for(i = 0; i < FND_MAX; ++i) if(timer_init[i] != '0') data = timer_init[i] - '0';
	print_data();
}

void dot_increase(void){
	++data;
	if(data == 9) data = 1;
	print_data();
}

void dot_del(void){
	int i;
	for(i = 0; i < 10; i++)
		outw(fpga_set_blank[i] & 0x7F, (unsigned int) iom_fpga_dot_addr + i * 2);
	iounmap(iom_fpga_dot_addr);
}
